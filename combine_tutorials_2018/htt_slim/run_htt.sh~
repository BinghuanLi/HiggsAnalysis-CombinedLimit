#!/bin/bash

ulimit -s unlimited

#curl -s https://raw.githubusercontent.com/cms-analysis/CombineHarvester/master/CombineTools/scripts/sparse-checkout-https.sh > sparse-checkout-https.sh
#chmod u+x sparse-checkout-https.sh
#./sparse-checkout-https.sh
#scram b -j 8
#cd HiggsAnalysis/CombinedLimit/combine_tutorials_2018/htt_slim/
#source /cvmfs/cms.cern.ch/cmsset_default.csh
#cmsenv
#source /cvmfs/cms.cern.ch/crab3/crab.sh
#voms-proxy-init -voms cms

# OBSERVED 

if [ $1 -eq "0" ]; then
# T2WS
echo "text2workspace.py -m 125 comb_2017_htt_slim.txt -o comb_2017_htt_slim.root --channel-masks"
text2workspace.py -m 125 comb_2017_htt_slim.txt -o comb_2017_htt_slim.root --channel-masks
fi

if [ $1 -eq "1" ]; then
#strategy 0 is no covariance matrix, strategy 1 is with covariance matrix
echo "combine -M MultiDimFit -m 125.09 -d comb_2017_htt_slim.root -n BestFit_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --saveToys --saveWorkspace --saveFitResult"
combine -M MultiDimFit -m 125.09 -d comb_2017_htt_slim.root -n BestFit_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --saveToys --saveWorkspace --saveFitResult
fi

if [ $1 -eq "2" ]; then
# load best fit snapshot from step 1
# compute uncertainties using algo singles
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_AllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -n mu_htt_slim_AllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1
fi
 
if [ $1 -eq "3" ]; then
# load best fit snapshot from step 1
# compute uncertainties from step 1 using algo singles but freeze all constrained nuisance parameters
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root  -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_StatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1 --freezeParameters all"
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root  -w w --snapshotName "MultiDimFit" -n mu_htt_slim_StatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1 --freezeParameters all
fi

if [ $1 -eq "4" ]; then
# load best fit snapshot from step 1
# compute uncertainties using algo grid with auto range
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_ScanAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  --skipInitialFit --algo=grid  --autoRange 3 --points 30 "
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -n mu_htt_slim_ScanAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=grid  --autoRange 3 --points 30 
fi
 

if [ $1 -eq "5" ]; then
# load best fit snapshot from step 1
# compute uncertainties using algo grid with auto range but freeze all constrained nuisance parameters
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_ScanStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30 --freezeParameters all"
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFit_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -n mu_htt_slim_ScanStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30 --freezeParameters all
fi
 

if [ $1 -eq "6" ]; then
# plot the 1D scans breaking down stat. and syst. components
echo "plot1DScan.py higgsCombinemu_htt_slim_ScanAllUnc.MultiDimFit.mH125.09.root --main-label \"Observed\" --others \"higgsCombinemu_htt_slim_ScanStatOnly.MultiDimFit.mH125.09.root:Stat. Only:2\" --POI r --breakdown syst,stat --output scan_vhbb_r"
plot1DScan.py higgsCombinemu_htt_slim_ScanAllUnc.MultiDimFit.mH125.09.root --main-label "Observed" --others "higgsCombinemu_htt_slim_ScanStatOnly.MultiDimFit.mH125.09.root:Stat. Only:2" --POI r --breakdown syst,stat --output scan_vhbb_r
fi

# PREFIT ASIMOV

if [ $1 -eq "7" ]; then
# generate prefit asimov dataset with r=1 and fit it
echo "combine -M MultiDimFit -m 125.09 -d comb_2017_htt_slim.root -n BestFitAsimov_htt_slim --setParameters r=1 -t -1 --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --saveToys --saveWorkspace --saveFitResult"
combine -M MultiDimFit -m 125.09 -d comb_2017_htt_slim.root -n BestFitAsimov_htt_slim --setParameters r=1 -t -1 --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --saveToys --saveWorkspace --saveFitResult
fi

if [ $1 -eq "8" ]; then
# load prefit asimov best fit snapshot from step 7
# compute uncertainties on r from prefit asimov dataset with r=1 using algo singles
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_AsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_AsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1
fi


if [ $1 -eq "9" ]; then
# load prefit asimov best fit snapshot from step 7
# compute uncertainties on r from prefit asimov dataset with r=1 using algo singles but freeze constrained NPs
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_AsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1 --freezeParameters all" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_AsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1 --freezeParameters all
fi


if [ $1 -eq "10" ]; then
# load prefit asimov best fit snapshot from step 7
# compute uncertainties on r from prefit asimov dataset with r=1 using algo singles
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_ScanAsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_ScanAsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30
fi


if [ $1 -eq "11" ]; then
# load prefit asimov best fit snapshot from step 7
# compute uncertainties on r from prefit asimov dataset with r=1 using algo singles but freeze constrained NPs
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_ScanAsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30 --freezeParameters all" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_ScanAsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid --autoRange 3 --points 30 --freezeParameters all
fi

if [ $1 -eq "12" ]; then
# plot the 1D scans breaking down stat. and syst. components
echo "plot1DScan.py higgsCombinemu_htt_slim_ScanAsimovAllUnc.MultiDimFit.mH125.09.root --main-label \"Expected\" --others \"higgsCombinemu_htt_slim_ScanAsimovStatOnly.MultiDimFit.mH125.09.root:Stat. Only:2\" --POI r --breakdown syst,stat --output scan_vhbb_r"
plot1DScan.py higgsCombinemu_htt_slim_ScanAsimovAllUnc.MultiDimFit.mH125.09.root --main-label "Expected" --others "higgsCombinemu_htt_slim_ScanAsimovStatOnly.MultiDimFit.mH125.09.root:Stat. Only:2" --POI r --breakdown syst,stat --output asimovscan_vhbb_r
fi

# POSTFIT ASIMOV
if [ $1 -eq "13" ]; then
# generate postfit asimov dataset with r=1 and fit it
echo "combine -M MultiDimFit -m 125.09 -d comb_2017_htt_slim.root -n BestFitPostfitAsimov_htt_slim --setParameters r=1 -t -1 --toysFrequentist --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --saveToys --saveWorkspace --saveFitResult"
combine -M MultiDimFit -m 125.09 -d comb_2017_htt_slim.root -n BestFitPostfitAsimov_htt_slim --setParameters r=1 -t -1 --toysFrequentist --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --saveToys --saveWorkspace --saveFitResult
fi

if [ $1 -eq "14" ]; then
# load postfit asimov best fit snapshot from step 7
# compute uncertainties on r from postfit asimov dataset with r=1 using algo singles
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_PostfitAsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_PostfitAsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1
fi


if [ $1 -eq "15" ]; then
# load postfit asimov best fit snapshot from step 7
# compute uncertainties on r from postfit asimov dataset with r=1 using algo singles but freeze constrained NPs
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_PostfitAsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1 --freezeParameters all" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_PostfitAsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --algo=singles --robustFit=1 --freezeParameters all
fi


if [ $1 -eq "16" ]; then
# load postfit asimov best fit snapshot from step 7
# compute uncertainties on r from postfit asimov dataset with r=1 using algo grid
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_ScanPostfitAsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_ScanPostfitAsimovAllUnc --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30
fi


if [ $1 -eq "17" ]; then
# load postfit asimov best fit snapshot from step 7
# compute uncertainties on r from postfit asimov dataset with r=1 using algo grid but freeze constrained NPs
echo "combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName \"MultiDimFit\" -n mu_htt_slim_ScanPostfitAsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid  --autoRange 3 --points 30 --freezeParameters all" 
combine -M MultiDimFit -m 125.09 -d higgsCombineBestFitPostfitAsimov_htt_slim.MultiDimFit.mH125.09.123456.root -w w --snapshotName "MultiDimFit" -D toys/toy_asimov -n mu_htt_slim_ScanPostfitAsimovStatOnly --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --skipInitialFit --algo=grid --autoRange 3 --points 30 --freezeParameters all
fi

if [ $1 -eq "18" ]; then
# plot the 1D scans from postfit asimov breaking down stat. and syst. components
echo "plot1DScan.py higgsCombinemu_htt_slim_ScanPostfitAsimovAllUnc.MultiDimFit.mH125.09.root --main-label \"Post-Fit Expected\" --others \"higgsCombinemu_htt_slim_ScanPostfitAsimovStatOnly.MultiDimFit.mH125.09.root:Stat. Only:2\" --POI r --breakdown syst,stat --output scan_vhbb_r"
plot1DScan.py higgsCombinemu_htt_slim_ScanPostfitAsimovAllUnc.MultiDimFit.mH125.09.root --main-label "Post-Fit Expected" --others "higgsCombinemu_htt_slim_ScanPostfitAsimovStatOnly.MultiDimFit.mH125.09.root:Stat. Only:2" --POI r --breakdown syst,stat --output postfitasimovscan_vhbb_r
fi


# Expected Impacts (Subset)

if [ $1 -eq "19" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n ImpactsAsimov_htt_slim --setParameters r=1 -t -1 --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 0 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  --doInitialFit --robustFit 1
fi


if [ $1 -eq "20" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n ImpactsAsimov_htt_slim --setParameters r=1 -t -1 --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --doFits --robustFit 1 --parallel 8 --named BR_htt_PU_alphas,BR_htt_PU_mq,BR_htt_THU,BR_hww_PU_alphas,BR_hww_PU_mq,BR_hww_THU,CMS_PS,CMS_eFakeTau_1prong1pizero_13TeV,CMS_eFakeTau_1prong_13TeV,CMS_eff_b_13TeV,CMS_eff_t_13TeV,CMS_eff_t_et_13TeV,CMS_eff_t_mt_13TeV,CMS_eff_t_tt_13TeV,CMS_eff_trigger_em_13TeV,CMS_eff_trigger_et_13TeV,CMS_eff_trigger_mt_13TeV,CMS_eff_trigger_tt_13TeV,CMS_htt_QCD_0jet_em_13TeV,CMS_htt_QCD_0jet_tt_13TeV,CMS_htt_QCD_VBF_em_13TeV,CMS_htt_QCD_VBF_tt_13TeV,CMS_htt_QCD_boosted_em_13TeV,CMS_htt_QCD_boosted_tt_13TeV,CMS_htt_eff_e,CMS_htt_eff_m,CMS_htt_jetFakeLep_13TeV,CMS_htt_scale_met_13TeV,CMS_htt_vvXsec_13TeV,CMS_htt_wjXsec_13TeV,CMS_htt_zmm_norm_extrap_0jet_em_13TeV,CMS_htt_zmm_norm_extrap_0jet_lt_13TeV,CMS_htt_zmm_norm_extrap_0jet_tt_13TeV,CMS_htt_zmm_norm_extrap_VBF_em_13TeV,CMS_htt_zmm_norm_extrap_VBF_lt_13TeV,CMS_htt_zmm_norm_extrap_VBF_tt_13TeV,CMS_htt_zmm_norm_extrap_boosted_em_13TeV,CMS_htt_zmm_norm_extrap_boosted_lt_13TeV,CMS_htt_zmm_norm_extrap_boosted_tt_13TeV,CMS_mFakeTau_1prong1pizero_13TeV,CMS_mFakeTau_1prong_13TeV,CMS_scale_e_em_13TeV,CMS_tauDMReco_1prong1pizero_13TeV,CMS_tauDMReco_1prong_13TeV,CMS_tauDMReco_3prong_13TeV,QCD_Extrap_Iso_nonIso_et_13TeV,QCD_Extrap_Iso_nonIso_mt_13TeV,QCDscale_qqH,THU_ggH_Mig01,THU_ggH_Mig12,THU_ggH_PT120,THU_ggH_PT60,THU_ggH_Res,THU_ggH_VBF2j,THU_ggH_VBF3j,THU_ggH_qmtop,WHighMTtoLowMT_0jet_13TeV,WHighMTtoLowMT_boosted_13TeV,WHighMTtoLowMT_vbf_13TeV,WSFUncert_et_0jet_13TeV,WSFUncert_et_boosted_13TeV,WSFUncert_et_vbf_13TeV,WSFUncert_mt_0jet_13TeV,WSFUncert_mt_boosted_13TeV,WSFUncert_mt_vbf_13TeV,lumi_13TeV_2016,pdf_Higgs_gg,pdf_Higgs_qqbar
fi

if [ $1 -eq "21" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n ImpactsAsimov_htt_slim --setParameters r=1 -t -1 --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  -o impacts_asimov.json --named BR_htt_PU_alphas,BR_htt_PU_mq,BR_htt_THU,BR_hww_PU_alphas,BR_hww_PU_mq,BR_hww_THU,CMS_PS,CMS_eFakeTau_1prong1pizero_13TeV,CMS_eFakeTau_1prong_13TeV,CMS_eff_b_13TeV,CMS_eff_t_13TeV,CMS_eff_t_et_13TeV,CMS_eff_t_mt_13TeV,CMS_eff_t_tt_13TeV,CMS_eff_trigger_em_13TeV,CMS_eff_trigger_et_13TeV,CMS_eff_trigger_mt_13TeV,CMS_eff_trigger_tt_13TeV,CMS_htt_QCD_0jet_em_13TeV,CMS_htt_QCD_0jet_tt_13TeV,CMS_htt_QCD_VBF_em_13TeV,CMS_htt_QCD_VBF_tt_13TeV,CMS_htt_QCD_boosted_em_13TeV,CMS_htt_QCD_boosted_tt_13TeV,CMS_htt_eff_e,CMS_htt_eff_m,CMS_htt_jetFakeLep_13TeV,CMS_htt_scale_met_13TeV,CMS_htt_vvXsec_13TeV,CMS_htt_wjXsec_13TeV,CMS_htt_zmm_norm_extrap_0jet_em_13TeV,CMS_htt_zmm_norm_extrap_0jet_lt_13TeV,CMS_htt_zmm_norm_extrap_0jet_tt_13TeV,CMS_htt_zmm_norm_extrap_VBF_em_13TeV,CMS_htt_zmm_norm_extrap_VBF_lt_13TeV,CMS_htt_zmm_norm_extrap_VBF_tt_13TeV,CMS_htt_zmm_norm_extrap_boosted_em_13TeV,CMS_htt_zmm_norm_extrap_boosted_lt_13TeV,CMS_htt_zmm_norm_extrap_boosted_tt_13TeV,CMS_mFakeTau_1prong1pizero_13TeV,CMS_mFakeTau_1prong_13TeV,CMS_scale_e_em_13TeV,CMS_tauDMReco_1prong1pizero_13TeV,CMS_tauDMReco_1prong_13TeV,CMS_tauDMReco_3prong_13TeV,QCD_Extrap_Iso_nonIso_et_13TeV,QCD_Extrap_Iso_nonIso_mt_13TeV,QCDscale_qqH,THU_ggH_Mig01,THU_ggH_Mig12,THU_ggH_PT120,THU_ggH_PT60,THU_ggH_Res,THU_ggH_VBF2j,THU_ggH_VBF3j,THU_ggH_qmtop,WHighMTtoLowMT_0jet_13TeV,WHighMTtoLowMT_boosted_13TeV,WHighMTtoLowMT_vbf_13TeV,WSFUncert_et_0jet_13TeV,WSFUncert_et_boosted_13TeV,WSFUncert_et_vbf_13TeV,WSFUncert_mt_0jet_13TeV,WSFUncert_mt_boosted_13TeV,WSFUncert_mt_vbf_13TeV,lumi_13TeV_2016,pdf_Higgs_gg,pdf_Higgs_qqbar
fi

if [ $1 -eq "22" ]; then
plotImpacts.py -i impacts_asimov.json -o impacts_asimov
fi

# Observed Impacts (Subset)

if [ $1 -eq "23" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n Impacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  --doInitialFit --robustFit 1
fi


if [ $1 -eq "24" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n Impacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --doFits --robustFit 1 --parallel 8 --named BR_htt_PU_alphas,BR_htt_PU_mq,BR_htt_THU,BR_hww_PU_alphas,BR_hww_PU_mq,BR_hww_THU,CMS_PS,CMS_eFakeTau_1prong1pizero_13TeV,CMS_eFakeTau_1prong_13TeV,CMS_eff_b_13TeV,CMS_eff_t_13TeV,CMS_eff_t_et_13TeV,CMS_eff_t_mt_13TeV,CMS_eff_t_tt_13TeV,CMS_eff_trigger_em_13TeV,CMS_eff_trigger_et_13TeV,CMS_eff_trigger_mt_13TeV,CMS_eff_trigger_tt_13TeV,CMS_htt_QCD_0jet_em_13TeV,CMS_htt_QCD_0jet_tt_13TeV,CMS_htt_QCD_VBF_em_13TeV,CMS_htt_QCD_VBF_tt_13TeV,CMS_htt_QCD_boosted_em_13TeV,CMS_htt_QCD_boosted_tt_13TeV,CMS_htt_eff_e,CMS_htt_eff_m,CMS_htt_jetFakeLep_13TeV,CMS_htt_scale_met_13TeV,CMS_htt_vvXsec_13TeV,CMS_htt_wjXsec_13TeV,CMS_htt_zmm_norm_extrap_0jet_em_13TeV,CMS_htt_zmm_norm_extrap_0jet_lt_13TeV,CMS_htt_zmm_norm_extrap_0jet_tt_13TeV,CMS_htt_zmm_norm_extrap_VBF_em_13TeV,CMS_htt_zmm_norm_extrap_VBF_lt_13TeV,CMS_htt_zmm_norm_extrap_VBF_tt_13TeV,CMS_htt_zmm_norm_extrap_boosted_em_13TeV,CMS_htt_zmm_norm_extrap_boosted_lt_13TeV,CMS_htt_zmm_norm_extrap_boosted_tt_13TeV,CMS_mFakeTau_1prong1pizero_13TeV,CMS_mFakeTau_1prong_13TeV,CMS_scale_e_em_13TeV,CMS_tauDMReco_1prong1pizero_13TeV,CMS_tauDMReco_1prong_13TeV,CMS_tauDMReco_3prong_13TeV,QCD_Extrap_Iso_nonIso_et_13TeV,QCD_Extrap_Iso_nonIso_mt_13TeV,QCDscale_qqH,THU_ggH_Mig01,THU_ggH_Mig12,THU_ggH_PT120,THU_ggH_PT60,THU_ggH_Res,THU_ggH_VBF2j,THU_ggH_VBF3j,THU_ggH_qmtop,WHighMTtoLowMT_0jet_13TeV,WHighMTtoLowMT_boosted_13TeV,WHighMTtoLowMT_vbf_13TeV,WSFUncert_et_0jet_13TeV,WSFUncert_et_boosted_13TeV,WSFUncert_et_vbf_13TeV,WSFUncert_mt_0jet_13TeV,WSFUncert_mt_boosted_13TeV,WSFUncert_mt_vbf_13TeV,lumi_13TeV_2016,pdf_Higgs_gg,pdf_Higgs_qqbar
fi

if [ $1 -eq "25" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n Impacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  -o impacts.json --named BR_htt_PU_alphas,BR_htt_PU_mq,BR_htt_THU,BR_hww_PU_alphas,BR_hww_PU_mq,BR_hww_THU,CMS_PS,CMS_eFakeTau_1prong1pizero_13TeV,CMS_eFakeTau_1prong_13TeV,CMS_eff_b_13TeV,CMS_eff_t_13TeV,CMS_eff_t_et_13TeV,CMS_eff_t_mt_13TeV,CMS_eff_t_tt_13TeV,CMS_eff_trigger_em_13TeV,CMS_eff_trigger_et_13TeV,CMS_eff_trigger_mt_13TeV,CMS_eff_trigger_tt_13TeV,CMS_htt_QCD_0jet_em_13TeV,CMS_htt_QCD_0jet_tt_13TeV,CMS_htt_QCD_VBF_em_13TeV,CMS_htt_QCD_VBF_tt_13TeV,CMS_htt_QCD_boosted_em_13TeV,CMS_htt_QCD_boosted_tt_13TeV,CMS_htt_eff_e,CMS_htt_eff_m,CMS_htt_jetFakeLep_13TeV,CMS_htt_scale_met_13TeV,CMS_htt_vvXsec_13TeV,CMS_htt_wjXsec_13TeV,CMS_htt_zmm_norm_extrap_0jet_em_13TeV,CMS_htt_zmm_norm_extrap_0jet_lt_13TeV,CMS_htt_zmm_norm_extrap_0jet_tt_13TeV,CMS_htt_zmm_norm_extrap_VBF_em_13TeV,CMS_htt_zmm_norm_extrap_VBF_lt_13TeV,CMS_htt_zmm_norm_extrap_VBF_tt_13TeV,CMS_htt_zmm_norm_extrap_boosted_em_13TeV,CMS_htt_zmm_norm_extrap_boosted_lt_13TeV,CMS_htt_zmm_norm_extrap_boosted_tt_13TeV,CMS_mFakeTau_1prong1pizero_13TeV,CMS_mFakeTau_1prong_13TeV,CMS_scale_e_em_13TeV,CMS_tauDMReco_1prong1pizero_13TeV,CMS_tauDMReco_1prong_13TeV,CMS_tauDMReco_3prong_13TeV,QCD_Extrap_Iso_nonIso_et_13TeV,QCD_Extrap_Iso_nonIso_mt_13TeV,QCDscale_qqH,THU_ggH_Mig01,THU_ggH_Mig12,THU_ggH_PT120,THU_ggH_PT60,THU_ggH_Res,THU_ggH_VBF2j,THU_ggH_VBF3j,THU_ggH_qmtop,WHighMTtoLowMT_0jet_13TeV,WHighMTtoLowMT_boosted_13TeV,WHighMTtoLowMT_vbf_13TeV,WSFUncert_et_0jet_13TeV,WSFUncert_et_boosted_13TeV,WSFUncert_et_vbf_13TeV,WSFUncert_mt_0jet_13TeV,WSFUncert_mt_boosted_13TeV,WSFUncert_mt_vbf_13TeV,lumi_13TeV_2016,pdf_Higgs_gg,pdf_Higgs_qqbar
fi

if [ $1 -eq "26" ]; then
plotImpacts.py -i impacts.json -o impacts
fi

# Observed Impacts (All, on the grid)

if [ $1 -eq "27" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n FullImpacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  --doInitialFit --robustFit 1 --allPars
fi


if [ $1 -eq "28" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n FullImpacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --doFits --robustFit 1 --robustHesse 1 --allPars --job-mode crab3 --task-name full_impacts_v3 --custom-crab custom_crab.py
#bash -c 'for f in /eos/uscms/store/user/dsperka/Combine_Tutorial_2018/Combine/full_impacts/181016_175717/0000/combine_output_*.tar; do tar xf $f; done'
fi

if [ $1 -eq "29" ]; then
combineTool.py -M Impacts -m 125.09 -d comb_2017_htt_slim.root -n FullImpacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH  -o fullimpacts.json --allPars
fi

if [ $1 -eq "30" ]; then
plotImpacts.py -i fullimpacts.json -o fullimpacts
fi


if [

#combineTool.py -M GoodnessOfFit --algorithm saturated -m 125.09 -d comb_2017_htt_slim.root -n FullImpacts_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --expectSignal 1.216 -s 1:1000:1 -t 1 --toysFrequentist --merge 10 --job-mode crab3 --task-name gof_saturated_v2 --custom-crab custom_crab.py

#combineTool.py -M GoodnessOfFit --algorithm KS -m 125.09 -d comb_2017_htt_slim.root -n GOF_KS_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --expectSignal 1.216 -s 1:1000:1 -t 1 --toysFrequentist --merge 10 --job-mode crab3 --task-name gof_KS_v2 --custom-crab custom_crab.py

# combine -M FitDiagnostics -m 125.09 -d comb_2017_htt_slim.root -n FitDiagnostics_htt_slim --setParameterRanges r=0.3,1.7 --cminDefaultMinimizerStrategy 1 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH 

#PostFitShapesFromWorkspace -w comb_2017_htt_slim.root -o comb_2017_htt_slim_shapes.root --samples 300 -f fitDiagnosticsFitDiagnostics_htt_slim.root:fit_s --postfit --sampling --skip-proc-errs

#combineTool.py -M HyrbridNew --LHCMode LHC-limits -m 125.09 -d comb_2017_htt_slim.root -n FullCLs_htt_slim --cminDefaultMinimizerStrategy 1 --cminFallbackAlgo Minuit2,Migrad,0:0.1 --cminFallbackAlgo Minuit2,Migrad,1:1.0 --cminFallbackAlgo Minuit2,Migrad,0:1.0 --X-rtd MINIMIZER_MaxCalls=999999999 --X-rtd MINIMIZER_analytic --X-rtd FAST_VERTICAL_MORPH --clsAcc 0 -s 1:20:1 -T 100 --saveHybridResult --singlePoint 0.1:2.1:0.2 --job-mode crab3 --task-name full_cls_v2 --custom-crab custom_crab.py



